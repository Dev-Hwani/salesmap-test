datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  A
  B
  C
}

enum ObjectType {
  DEAL
  LEAD
  CONTACT
  COMPANY
}

enum FieldType {
  text
  number
  date
  datetime
  single_select
  multi_select
  boolean
  user
  users
  file
  calculation
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  managerId    Int?
  manager      User?    @relation("UserManager", fields: [managerId], references: [id])
  subordinates User[]   @relation("UserManager")
  deals        Deal[]   @relation("DealOwner")
  leads        Lead[]   @relation("LeadOwner")
  contacts     Contact[] @relation("ContactOwner")
  companies    Company[] @relation("CompanyOwner")
  dealFieldValues    DealFieldValue[]
  leadFieldValues    LeadFieldValue[]
  contactFieldValues ContactFieldValue[]
  companyFieldValues CompanyFieldValue[]
  dealFieldUserValues    DealFieldUserValue[]
  leadFieldUserValues    LeadFieldUserValue[]
  contactFieldUserValues ContactFieldUserValue[]
  companyFieldUserValues CompanyFieldUserValue[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Pipeline {
  id        Int      @id @default(autoincrement())
  name      String
  position  Int      @default(0)
  stages    Stage[]
  deals     Deal[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Stage {
  id             Int      @id @default(autoincrement())
  pipelineId     Int
  name           String
  probability    Int?
  description    String?
  stagnationDays Int?
  position       Int      @default(0)
  pipeline       Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  deals          Deal[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([pipelineId])
}

model Deal {
  id              Int              @id @default(autoincrement())
  name            String
  expectedRevenue Float?
  closeDate       DateTime?
  pipelineId      Int
  stageId         Int
  ownerId         Int
  companyId       Int?
  contactId       Int?
  sourceLeadId    Int?
  pipeline        Pipeline         @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  stage           Stage            @relation(fields: [stageId], references: [id], onDelete: Restrict)
  owner           User             @relation("DealOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact         Contact?         @relation(fields: [contactId], references: [id], onDelete: SetNull)
  sourceLead      Lead?            @relation(fields: [sourceLeadId], references: [id], onDelete: SetNull)
  fieldValues     DealFieldValue[]
  optionValues    DealFieldOptionValue[]
  userValues      DealFieldUserValue[]
  files           DealFieldFile[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([pipelineId])
  @@index([stageId])
  @@index([ownerId])
  @@index([companyId])
  @@index([contactId])
  @@index([sourceLeadId])
}

model CustomField {
  id                Int              @id @default(autoincrement())
  objectType        ObjectType       @default(DEAL)
  label             String
  type              FieldType
  formula           String?
  required          Boolean          @default(false)
  masked            Boolean          @default(false)
  visibleInCreate   Boolean          @default(true)
  visibleInPipeline Boolean          @default(false)
  position          Int              @default(0)
  deletedAt         DateTime?
  options           CustomFieldOption[]
  dealValues        DealFieldValue[]
  leadValues        LeadFieldValue[]
  contactValues     ContactFieldValue[]
  companyValues     CompanyFieldValue[]
  dealOptionValues    DealFieldOptionValue[]
  leadOptionValues    LeadFieldOptionValue[]
  contactOptionValues ContactFieldOptionValue[]
  companyOptionValues CompanyFieldOptionValue[]
  dealUserValues    DealFieldUserValue[]
  leadUserValues    LeadFieldUserValue[]
  contactUserValues ContactFieldUserValue[]
  companyUserValues CompanyFieldUserValue[]
  dealFiles    DealFieldFile[]
  leadFiles    LeadFieldFile[]
  contactFiles ContactFieldFile[]
  companyFiles CompanyFieldFile[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([objectType, deletedAt])
}

model CustomFieldOption {
  id        Int         @id @default(autoincrement())
  fieldId   Int
  label     String
  position  Int         @default(0)
  deletedAt DateTime?
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  dealFieldValues    DealFieldValue[]
  leadFieldValues    LeadFieldValue[]
  contactFieldValues ContactFieldValue[]
  companyFieldValues CompanyFieldValue[]
  dealFieldOptionValues    DealFieldOptionValue[]
  leadFieldOptionValues    LeadFieldOptionValue[]
  contactFieldOptionValues ContactFieldOptionValue[]
  companyFieldOptionValues CompanyFieldOptionValue[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([fieldId, deletedAt])
}

model DealFieldValue {
  id            Int         @id @default(autoincrement())
  dealId        Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  deal          Deal        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field         CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation(fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation(fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([dealId, fieldId])
  @@index([fieldId])
}

model DealFieldOptionValue {
  id        Int         @id @default(autoincrement())
  dealId    Int
  fieldId   Int
  optionId  Int
  deal      Deal        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([dealId, fieldId, optionId])
  @@index([fieldId])
}

model DealFieldUserValue {
  id        Int      @id @default(autoincrement())
  dealId    Int
  fieldId   Int
  userId    Int
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([dealId, fieldId, userId])
  @@index([fieldId])
}

model DealFieldFile {
  id           Int      @id @default(autoincrement())
  dealId       Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  deal         Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
}

model Lead {
  id          Int        @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  companyId   Int?
  status      LeadStatus @default(NEW)
  ownerId     Int
  company     Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner       User       @relation("LeadOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  fieldValues LeadFieldValue[]
  optionValues LeadFieldOptionValue[]
  userValues   LeadFieldUserValue[]
  files        LeadFieldFile[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([companyId])
  @@index([deletedAt])
}

model Contact {
  id          Int        @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  companyId   Int?
  ownerId     Int
  company     Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner       User       @relation("ContactOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  fieldValues ContactFieldValue[]
  optionValues ContactFieldOptionValue[]
  userValues   ContactFieldUserValue[]
  files        ContactFieldFile[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([companyId])
  @@index([deletedAt])
}

model Company {
  id          Int       @id @default(autoincrement())
  name        String
  industry    String?
  size        String?
  ownerId     Int
  owner       User      @relation("CompanyOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  contacts    Contact[]
  leads       Lead[]
  fieldValues CompanyFieldValue[]
  optionValues CompanyFieldOptionValue[]
  userValues   CompanyFieldUserValue[]
  files        CompanyFieldFile[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([deletedAt])
}

model LeadFieldValue {
  id            Int         @id @default(autoincrement())
  leadId        Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field         CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation(fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation(fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([leadId, fieldId])
  @@index([fieldId])
}

model LeadFieldOptionValue {
  id        Int         @id @default(autoincrement())
  leadId    Int
  fieldId   Int
  optionId  Int
  lead      Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([leadId, fieldId, optionId])
  @@index([fieldId])
}

model LeadFieldUserValue {
  id        Int      @id @default(autoincrement())
  leadId    Int
  fieldId   Int
  userId    Int
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([leadId, fieldId, userId])
  @@index([fieldId])
}

model LeadFieldFile {
  id           Int      @id @default(autoincrement())
  leadId       Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
}

model ContactFieldValue {
  id            Int         @id @default(autoincrement())
  contactId     Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field         CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation(fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation(fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([contactId, fieldId])
  @@index([fieldId])
}

model ContactFieldOptionValue {
  id        Int         @id @default(autoincrement())
  contactId Int
  fieldId   Int
  optionId  Int
  contact   Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([contactId, fieldId, optionId])
  @@index([fieldId])
}

model ContactFieldUserValue {
  id        Int      @id @default(autoincrement())
  contactId Int
  fieldId   Int
  userId    Int
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([contactId, fieldId, userId])
  @@index([fieldId])
}

model ContactFieldFile {
  id           Int      @id @default(autoincrement())
  contactId    Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  contact      Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
}

model CompanyFieldValue {
  id            Int         @id @default(autoincrement())
  companyId     Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field         CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation(fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation(fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([companyId, fieldId])
  @@index([fieldId])
}

model CompanyFieldOptionValue {
  id        Int         @id @default(autoincrement())
  companyId Int
  fieldId   Int
  optionId  Int
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([companyId, fieldId, optionId])
  @@index([fieldId])
}

model CompanyFieldUserValue {
  id        Int      @id @default(autoincrement())
  companyId Int
  fieldId   Int
  userId    Int
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([companyId, fieldId, userId])
  @@index([fieldId])
}

model CompanyFieldFile {
  id           Int      @id @default(autoincrement())
  companyId    Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
}
