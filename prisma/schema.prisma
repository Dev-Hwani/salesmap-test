datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  A
  B
  C
}

enum ObjectType {
  DEAL
  LEAD
  CONTACT
  COMPANY
}

enum FieldType {
  text
  number
  date
  datetime
  single_select
  multi_select
  boolean
  user
  users
  file
  calculation
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

enum AuditEntityType {
  DEAL
  LEAD
  CONTACT
  COMPANY
  PIPELINE
  STAGE
  CUSTOM_FIELD
  FILE
  USER
  TEAM
  WORKSPACE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STAGE_MOVE
  FILE_UPLOAD
  FILE_DELETE
  FILE_REPLACE
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  managerId    Int?
  workspaceId  Int?
  teamId       Int?
  manager      User?    @relation("UserManager", fields: [managerId], references: [id])
  subordinates User[]   @relation("UserManager")
  workspace    Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  team         Team?      @relation(fields: [teamId], references: [id], onDelete: SetNull)
  deals        Deal[]   @relation("DealOwner")
  leads        Lead[]   @relation("LeadOwner")
  contacts     Contact[] @relation("ContactOwner")
  companies    Company[] @relation("CompanyOwner")
  dealFieldValues    DealFieldValue[] @relation("DealFieldValueUser")
  leadFieldValues    LeadFieldValue[] @relation("LeadFieldValueUser")
  contactFieldValues ContactFieldValue[] @relation("ContactFieldValueUser")
  companyFieldValues CompanyFieldValue[] @relation("CompanyFieldValueUser")
  dealFieldUserValues    DealFieldUserValue[] @relation("DealFieldUserValueUser")
  leadFieldUserValues    LeadFieldUserValue[] @relation("LeadFieldUserValueUser")
  contactFieldUserValues ContactFieldUserValue[] @relation("ContactFieldUserValueUser")
  companyFieldUserValues CompanyFieldUserValue[] @relation("CompanyFieldUserValueUser")
  auditLogs   AuditLog[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([workspaceId])
  @@index([teamId])
}

model Pipeline {
  id        Int      @id @default(autoincrement())
  name      String
  position  Int      @default(0)
  workspaceId Int?
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  stages    Stage[]
  deals     Deal[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

model Stage {
  id             Int      @id @default(autoincrement())
  pipelineId     Int
  name           String
  probability    Int?
  description    String?
  stagnationDays Int?
  position       Int      @default(0)
  pipeline       Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  deals          Deal[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([pipelineId])
}

model Deal {
  id              Int              @id @default(autoincrement())
  name            String
  expectedRevenue Float?
  closeDate       DateTime?
  pipelineId      Int
  stageId         Int
  ownerId         Int
  companyId       Int?
  contactId       Int?
  sourceLeadId    Int?
  pipeline        Pipeline         @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  stage           Stage            @relation(fields: [stageId], references: [id], onDelete: Restrict)
  owner           User             @relation("DealOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact         Contact?         @relation(fields: [contactId], references: [id], onDelete: SetNull)
  sourceLead      Lead?            @relation(fields: [sourceLeadId], references: [id], onDelete: SetNull)
  fieldValues     DealFieldValue[]
  optionValues    DealFieldOptionValue[]
  userValues      DealFieldUserValue[]
  files           DealFieldFile[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([pipelineId])
  @@index([stageId])
  @@index([ownerId])
  @@index([companyId])
  @@index([contactId])
  @@index([sourceLeadId])
}

model CustomField {
  id                Int              @id @default(autoincrement())
  objectType        ObjectType       @default(DEAL)
  label             String
  type              FieldType
  formula           String?
  required          Boolean          @default(false)
  masked            Boolean          @default(false)
  visibleInCreate   Boolean          @default(true)
  visibleInPipeline Boolean          @default(false)
  position          Int              @default(0)
  deletedAt         DateTime?
  workspaceId       Int?
  options           CustomFieldOption[]
  dealValues        DealFieldValue[] @relation("DealFieldValueField")
  leadValues        LeadFieldValue[] @relation("LeadFieldValueField")
  contactValues     ContactFieldValue[] @relation("ContactFieldValueField")
  companyValues     CompanyFieldValue[] @relation("CompanyFieldValueField")
  dealOptionValues    DealFieldOptionValue[] @relation("DealFieldOptionValueField")
  leadOptionValues    LeadFieldOptionValue[] @relation("LeadFieldOptionValueField")
  contactOptionValues ContactFieldOptionValue[] @relation("ContactFieldOptionValueField")
  companyOptionValues CompanyFieldOptionValue[] @relation("CompanyFieldOptionValueField")
  dealUserValues    DealFieldUserValue[] @relation("DealFieldUserValueField")
  leadUserValues    LeadFieldUserValue[] @relation("LeadFieldUserValueField")
  contactUserValues ContactFieldUserValue[] @relation("ContactFieldUserValueField")
  companyUserValues CompanyFieldUserValue[] @relation("CompanyFieldUserValueField")
  dealFiles    DealFieldFile[] @relation("DealFieldFileField")
  leadFiles    LeadFieldFile[] @relation("LeadFieldFileField")
  contactFiles ContactFieldFile[] @relation("ContactFieldFileField")
  companyFiles CompanyFieldFile[] @relation("CompanyFieldFileField")
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([objectType, deletedAt])
  @@index([workspaceId])
}

model CustomFieldOption {
  id        Int         @id @default(autoincrement())
  fieldId   Int
  label     String
  position  Int         @default(0)
  deletedAt DateTime?
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  dealFieldValues    DealFieldValue[] @relation("DealFieldValueOption")
  leadFieldValues    LeadFieldValue[] @relation("LeadFieldValueOption")
  contactFieldValues ContactFieldValue[] @relation("ContactFieldValueOption")
  companyFieldValues CompanyFieldValue[] @relation("CompanyFieldValueOption")
  dealFieldOptionValues    DealFieldOptionValue[] @relation("DealFieldOptionValueOption")
  leadFieldOptionValues    LeadFieldOptionValue[] @relation("LeadFieldOptionValueOption")
  contactFieldOptionValues ContactFieldOptionValue[] @relation("ContactFieldOptionValueOption")
  companyFieldOptionValues CompanyFieldOptionValue[] @relation("CompanyFieldOptionValueOption")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([fieldId, deletedAt])
}

model DealFieldValue {
  id            Int         @id @default(autoincrement())
  dealId        Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  deal          Deal        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field         CustomField @relation("DealFieldValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation("DealFieldValueUser", fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation("DealFieldValueOption", fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([dealId, fieldId])
  @@index([fieldId])
}

model DealFieldOptionValue {
  id        Int         @id @default(autoincrement())
  dealId    Int
  fieldId   Int
  optionId  Int
  deal      Deal        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field     CustomField @relation("DealFieldOptionValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation("DealFieldOptionValueOption", fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([dealId, fieldId, optionId])
  @@index([fieldId])
}

model DealFieldUserValue {
  id        Int      @id @default(autoincrement())
  dealId    Int
  fieldId   Int
  userId    Int
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field     CustomField @relation("DealFieldUserValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation("DealFieldUserValueUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([dealId, fieldId, userId])
  @@index([fieldId])
}

model DealFieldFile {
  id           Int      @id @default(autoincrement())
  dealId       Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  groupKey     String   @default(uuid())
  version      Int      @default(1)
  isCurrent    Boolean  @default(true)
  replacedAt   DateTime?
  deal         Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  field        CustomField @relation("DealFieldFileField", fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
  @@index([groupKey])
  @@index([isCurrent])
}

model Lead {
  id          Int        @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  companyId   Int?
  status      LeadStatus @default(NEW)
  ownerId     Int
  company     Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner       User       @relation("LeadOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  fieldValues LeadFieldValue[]
  optionValues LeadFieldOptionValue[]
  userValues   LeadFieldUserValue[]
  files        LeadFieldFile[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([companyId])
  @@index([deletedAt])
}

model Contact {
  id          Int        @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  companyId   Int?
  ownerId     Int
  company     Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner       User       @relation("ContactOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  fieldValues ContactFieldValue[]
  optionValues ContactFieldOptionValue[]
  userValues   ContactFieldUserValue[]
  files        ContactFieldFile[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([companyId])
  @@index([deletedAt])
}

model Company {
  id          Int       @id @default(autoincrement())
  name        String
  industry    String?
  size        String?
  ownerId     Int
  owner       User      @relation("CompanyOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  deals       Deal[]
  contacts    Contact[]
  leads       Lead[]
  fieldValues CompanyFieldValue[]
  optionValues CompanyFieldOptionValue[]
  userValues   CompanyFieldUserValue[]
  files        CompanyFieldFile[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([ownerId])
  @@index([deletedAt])
}

model LeadFieldValue {
  id            Int         @id @default(autoincrement())
  leadId        Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field         CustomField @relation("LeadFieldValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation("LeadFieldValueUser", fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation("LeadFieldValueOption", fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([leadId, fieldId])
  @@index([fieldId])
}

model LeadFieldOptionValue {
  id        Int         @id @default(autoincrement())
  leadId    Int
  fieldId   Int
  optionId  Int
  lead      Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field     CustomField @relation("LeadFieldOptionValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation("LeadFieldOptionValueOption", fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([leadId, fieldId, optionId])
  @@index([fieldId])
}

model LeadFieldUserValue {
  id        Int      @id @default(autoincrement())
  leadId    Int
  fieldId   Int
  userId    Int
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field     CustomField @relation("LeadFieldUserValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation("LeadFieldUserValueUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([leadId, fieldId, userId])
  @@index([fieldId])
}

model LeadFieldFile {
  id           Int      @id @default(autoincrement())
  leadId       Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  groupKey     String   @default(uuid())
  version      Int      @default(1)
  isCurrent    Boolean  @default(true)
  replacedAt   DateTime?
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  field        CustomField @relation("LeadFieldFileField", fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
  @@index([groupKey])
  @@index([isCurrent])
}

model ContactFieldValue {
  id            Int         @id @default(autoincrement())
  contactId     Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field         CustomField @relation("ContactFieldValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation("ContactFieldValueUser", fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation("ContactFieldValueOption", fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([contactId, fieldId])
  @@index([fieldId])
}

model ContactFieldOptionValue {
  id        Int         @id @default(autoincrement())
  contactId Int
  fieldId   Int
  optionId  Int
  contact   Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field     CustomField @relation("ContactFieldOptionValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation("ContactFieldOptionValueOption", fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([contactId, fieldId, optionId])
  @@index([fieldId])
}

model ContactFieldUserValue {
  id        Int      @id @default(autoincrement())
  contactId Int
  fieldId   Int
  userId    Int
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field     CustomField @relation("ContactFieldUserValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation("ContactFieldUserValueUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([contactId, fieldId, userId])
  @@index([fieldId])
}

model ContactFieldFile {
  id           Int      @id @default(autoincrement())
  contactId    Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  groupKey     String   @default(uuid())
  version      Int      @default(1)
  isCurrent    Boolean  @default(true)
  replacedAt   DateTime?
  contact      Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field        CustomField @relation("ContactFieldFileField", fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
  @@index([groupKey])
  @@index([isCurrent])
}

model CompanyFieldValue {
  id            Int         @id @default(autoincrement())
  companyId     Int
  fieldId       Int
  valueText     String?
  valueNumber   Float?
  valueDate     DateTime?
  valueDateTime DateTime?
  valueBoolean  Boolean?
  valueUserId   Int?
  valueOptionId Int?
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field         CustomField @relation("CompanyFieldValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  valueUser     User?       @relation("CompanyFieldValueUser", fields: [valueUserId], references: [id], onDelete: SetNull)
  valueOption   CustomFieldOption? @relation("CompanyFieldValueOption", fields: [valueOptionId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([companyId, fieldId])
  @@index([fieldId])
}

model CompanyFieldOptionValue {
  id        Int         @id @default(autoincrement())
  companyId Int
  fieldId   Int
  optionId  Int
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field     CustomField @relation("CompanyFieldOptionValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  option    CustomFieldOption @relation("CompanyFieldOptionValueOption", fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([companyId, fieldId, optionId])
  @@index([fieldId])
}

model CompanyFieldUserValue {
  id        Int      @id @default(autoincrement())
  companyId Int
  fieldId   Int
  userId    Int
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field     CustomField @relation("CompanyFieldUserValueField", fields: [fieldId], references: [id], onDelete: Cascade)
  user      User     @relation("CompanyFieldUserValueUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([companyId, fieldId, userId])
  @@index([fieldId])
}

model CompanyFieldFile {
  id           Int      @id @default(autoincrement())
  companyId    Int
  fieldId      Int
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  groupKey     String   @default(uuid())
  version      Int      @default(1)
  isCurrent    Boolean  @default(true)
  replacedAt   DateTime?
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  field        CustomField @relation("CompanyFieldFileField", fields: [fieldId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fieldId])
  @@index([groupKey])
  @@index([isCurrent])
}

model Workspace {
  id        Int      @id @default(autoincrement())
  name      String
  users     User[]
  teams     Team[]
  pipelines Pipeline[]
  fields    CustomField[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id          Int       @id @default(autoincrement())
  name        String
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  users       User[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([workspaceId])
}

model AuditLog {
  id         Int             @id @default(autoincrement())
  actorId    Int
  entityType AuditEntityType
  entityId   Int?
  action     AuditAction
  before     Json?
  after      Json?
  meta       Json?
  actor      User            @relation(fields: [actorId], references: [id], onDelete: Restrict)
  createdAt  DateTime        @default(now())

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
